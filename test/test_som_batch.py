#!/usr/bin/env python3
# -*- coding: utf-8 -*-
########################################################################################################################

import os
import sys

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

########################################################################################################################

import pytest
import decontamination

import numpy as np

########################################################################################################################

data = np.random.default_rng(seed = 0).random((25_000, 4), np.float32)

########################################################################################################################

som = decontamination.SOM_Batch(4, 4, 4, dtype = np.float32, topology = 'square')

####################################################################################################################

@pytest.mark.parametrize('enable_gpu', [False, True])
def test_centroids(enable_gpu):

    expected = np.array([
        [[0.5373822 , 0.48880973, 0.4349715 , 0.506877 ],
        [0.5176099 , 0.492051  , 0.45989057, 0.49880785],
        [0.5021911 , 0.4981239 , 0.49330926, 0.49268693],
        [0.4944685 , 0.5062575 , 0.5335318 , 0.48986676]],

        [[0.50584465, 0.48597503, 0.44446665, 0.51188797],
        [0.49203745, 0.48803505, 0.46598452, 0.5012483],
        [0.48379517, 0.49383226, 0.4946648 , 0.49208862],
        [0.48327035, 0.50285083, 0.52911085, 0.48593333]],

        [[0.4741224 , 0.4853157 , 0.45887586, 0.5124782],
        [0.46750644, 0.48636997, 0.4772342 , 0.50160843],
        [0.46734107, 0.4917694 , 0.501466  , 0.49180615],
        [0.47486955, 0.5014552 , 0.530631  , 0.48477185]],

        [[0.44522905, 0.48773974, 0.47888815, 0.5091403],
        [0.44648308, 0.48800626, 0.49420998, 0.50008047],
        [0.45509592, 0.49324277, 0.5146117 , 0.4919658],
        [0.4711121 , 0.5034144 , 0.5392277 , 0.48615402]]
    ])

    som.init_rand(seed = 0)

    som.train(data, n_epochs = 1, enable_gpu = enable_gpu)

    assert np.allclose(som.get_centroids(), expected, rtol = 1e-4)

########################################################################################################################

if __name__ == '__main__':

    pytest.main([__file__])

########################################################################################################################
