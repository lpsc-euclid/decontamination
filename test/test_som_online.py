#!/usr/bin/env python3
# -*- coding: utf-8 -*-
########################################################################################################################

import os
import sys

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

########################################################################################################################

import pytest
import decontamination

import numpy as np

########################################################################################################################

data = np.random.default_rng(seed = 0).random((25_000, 4), np.float32)

########################################################################################################################

som = decontamination.SOM_Online(4, 4, 4, dtype = np.float32, topology = 'square')

####################################################################################################################

@pytest.mark.capture(no = True)
def test_centroids():

    expected = np.array([
        [[0.42434192, 0.4313746, 0.6314928, 0.4303455],
        [0.40088618, 0.4905263, 0.5490823, 0.36797205],
        [0.38297942, 0.5576409, 0.47568932, 0.34981096],
        [0.3648115, 0.61074746, 0.438604, 0.34619355]],

        [[0.47230792, 0.40924293, 0.5254587, 0.4411669],
        [0.4561938, 0.45208892, 0.42695683, 0.38369063],
        [0.4430029, 0.50279456, 0.34995863, 0.37014717],
        [0.4251146, 0.5507915, 0.3185692, 0.3720538]],

        [[0.5326678, 0.38281366, 0.4155064, 0.4692226],
        [0.5167223, 0.40349448, 0.31738138, 0.40270802],
        [0.5043199, 0.43680266, 0.24784835, 0.38016915],
        [0.48681706, 0.4804396, 0.22342062, 0.3813466]],

        [[0.5814714, 0.36759514, 0.3323821, 0.50771254],
        [0.5619757, 0.36889845, 0.24751386, 0.42586994],
        [0.5498622, 0.38958672, 0.18885592, 0.38805836],
        [0.53447276, 0.428252, 0.16794921, 0.38263935]]
    ])

    som.init_rand(seed = 0)

    som.train(data, n_epochs = 1)

    assert np.allclose(som.get_centroids(), expected)

########################################################################################################################

if __name__ == '__main__':

    pytest.main([__file__])

########################################################################################################################
